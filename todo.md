# Penguin-lang 可变性系统重构计划

**目标**: 将现有的三态（Auto, mut, !mut）可变性模型，重构为更简单、更清晰的“视图可变性” + “内部可变性”两层模型。

---

### Phase 1: 清理与简化语法模型

此阶段的目标是移除旧模型在语法和语义表示层面的痕迹。

1.  **移除 `!mut` 关键字**:
    *   [ ] **语法文件**: 修改 `PenguinLang.g4`，从类型声明的规则中彻底删除 `!mut`。
    *   [ ] **语法节点**: 检查并修改 `PenguinLangSyntax` 项目中的相关语法节点（SyntaxNode）类，移除与 `!mut` 相关的逻辑。
    *   [ ] **CST 到 AST**: 确保从 CST（ANTLR生成的树）到 AST 的转换逻辑不再处理 `!mut`。

2.  **简化 `Mutability` 枚举**:
    *   [ ] **定位枚举**: 找到 `BabyPenguin` 项目中定义可变性状态的枚举（例如 `Common.cs` 中的 `Mutability`）。
    *   [ ] **简化**: 将其状态从 `Auto`, `Mutable`, `Immutable` 简化。新的模型下，一个符号的可变性可以只有一个 `IsMutable` 布尔标记。在类型系统中，`mut` 作为一个修饰符存在。我们需要重新思考 `TypeInfo` 和 `VariableSymbol` 中可变性信息的存储方式。
        *   **建议**: `VariableSymbol` 中可以有一个 `IsMutableView` 标志。`TypeInfo` 中可以有一个 `HasInteriorMutability` 标志。

---

### Phase 2: 重构核心语义检查逻辑

此阶段是重构的核心，需要修改赋值和函数调用的检查规则。

1.  **定位赋值检查逻辑**:
    *   [ ] 找到处理赋值语句（如 `a = b` 或 `a.x = b`）的语义检查代码。这很可能在 `SemanticPass` 目录下的某个文件中，例如 `06_SyntaxRewriting.cs` 或 `09_CheckReturnValue.cs`，也可能在一个专门的检查文件中。

2.  **实现新的赋值规则**:
    *   [ ] **对于成员赋值 (`expr.member = ...`)**:
        1.  解析 `expr` 得到其对应的变量符号。
        2.  检查该变量符号是否被声明为 `let mut` (即“可变视图”)。如果是，则赋值合法。
        3.  如果不是，则检查 `member` 字段在 `class` 定义中是否被声明为 `mut` (即“内部可变性”)。如果是，则赋值合法。
        4.  如果以上都不满足，则抛出编译错误。
    *   [ ] **对于变量重赋值 (`a = ...`)**:
        1.  检查变量 `a` 在 `let` 声明时是否带有 `mut`。
        2.  只有 `let mut a` 声明的变量可以被重新赋值。

3.  **更新函数调用检查**:
    *   [ ] **参数传递**: 当函数参数被声明为 `mut` (如 `fun foo(p: mut Point)`) 时，确保传递给它的实参必须是一个“可变视图”的变量 (`let mut ...`)。
    *   [ ] **`this` 方法调用**: 当调用 `mut this` 方法时 (如 `a.mut_method()`)，确保实例 `a` 是一个“可变视图”的变量。

4.  **优化错误信息**:
    *   [ ] 按照我们之前的讨论，为不合法的赋值操作提供清晰、有指导性的错误提示。

---

### Phase 3: 更新测试用例

此阶段的目标是确保新的可变性模型按预期工作，并且没有破坏现有功能。

1.  **修改 `MutabilityTest.cs`**:
    *   [ ] **删除旧测试**: 删除所有与 `!mut` 相关的测试用例。
    *   [ ] **修改现有测试**:
        *   重写依赖于旧 `Auto` 行为的测试。例如，`CascadeClassMutableMemberAssignmentTest3` 现在应该会编译失败，除非实例 `b` 被声明为 `let mut B`。
        *   调整 `ClassImmutableAssignmentErrorTest` 等测试，使其符合新的“视图”规则。
    *   [ ] **添加新测试**:
        *   编写测试用例，明确验证“可变视图”可以修改普通成员。
        *   编写测试用例，明确验证“不可变视图”**不能**修改普通成员。
        *   编写测试用例，明确验证“不可变视图”**可以**修改“内部可变”成员。

2.  **运行所有测试**:
    *   [ ] 执行 `dotnet test`，确保所有测试（包括 `MutabilityTest` 之外的）都能通过，修复所有因模型修改导致的回归问题。

---

### Phase 4: 文档和收尾

1.  **更新语言文档**:
    *   [ ] 修改 `Documentation` 目录下的 `.md` 文件，特别是 `03_DataTypes.md`，用新的可变性规则替换旧的描述。
2.  **代码清理**:
    *   [ ] 移除项目中所有与旧可变性系统相关的、现已不再使用的代码。

---
